---
name: sync-jira
description: "Push a validated PRD to Jira, creating an epic and linked story tickets. Use when you have a prd.json ready and want to track it in Jira. Triggers on: sync to jira, push to jira, create jira tickets, sync-jira."
---

# Sync PRD to Jira

Pushes a validated prd.json to Atlassian Jira, creating an epic for the project and individual tickets for each user story.

---

## Prerequisites

Before running this skill, ensure:

1. **Atlassian MCP server is configured** in `~/.claude/mcp_servers.json`
2. **Per-project Jira config exists** at `.ralph/jira.json` (copy from `.ralph/jira.json.example`)
3. **prd.json exists** with valid user stories

---

## The Job

1. Validate prerequisites (Jira config, PRD file)
2. Create a Jira epic for the PRD
3. Create story tickets linked to the epic
4. Update prd.json with Jira references

---

## Step 1: Locate and Validate PRD

### Find PRD File

Check for prd.json in the following locations (in order):
1. Current working directory: `./prd.json`
2. User-specified path (if provided as argument)

If no prd.json found, check for PRD markdown files:
1. `tasks/prd-*.md` files
2. If multiple exist, prompt user to specify which one

**If no PRD found:** Stop and inform user to create a PRD first using `/prd` skill, then convert with `/ralph` skill.

### Validate PRD Structure

The prd.json must contain:
```json
{
  "project": "string (required)",
  "branchName": "string (required)",
  "description": "string (required)",
  "userStories": [
    {
      "id": "string (required)",
      "title": "string (required)",
      "description": "string (required)",
      "acceptanceCriteria": ["array of strings (required)"],
      "priority": "number (required)",
      "passes": "boolean (required)",
      "notes": "string (optional)"
    }
  ]
}
```

**Validation errors:** Stop and report missing/invalid fields.

---

## Step 2: Validate Jira Configuration

### Load Configuration

Read `.ralph/jira.json` from the project root.

**If file doesn't exist:**
```
Error: Jira configuration not found at .ralph/jira.json

To set up Jira integration:
1. Copy the example: cp .ralph/jira.json.example .ralph/jira.json
2. Edit .ralph/jira.json with your project settings
3. Run /sync-jira again

See README.md "Jira Integration" section for details.
```

### Required Fields

Validate these fields exist and are non-empty:
- `projectKey` - Jira project key (e.g., "PROJ")
- `atlassianSiteUrl` - Atlassian instance URL
- `epicIssueType` - Issue type for epics (usually "Epic")
- `storyIssueType` - Issue type for stories

### Optional Fields (with defaults)

- `subtaskIssueType` - Default: "Sub-task"
- `defaultLabels` - Default: []
- `statusMapping` - Default: { "start": "In Progress", "done": "Done", "fail": "In Progress" }
- `epicLinkField` - Default: "Epic Link"
- `components` - Default: []
- `customFields` - Default: {}

---

## Step 3: Verify MCP Connection

Before creating any tickets, verify the Atlassian MCP server is available.

### Check MCP Tools

Attempt to list available Jira tools. The Atlassian MCP server should provide:
- `jira-create-issue` or similar for creating issues
- `jira-get-issue-types` for listing issue types

**If MCP tools not available:**
```
Error: Atlassian MCP server not configured or not responding.

To set up the MCP server:
1. Install: npm install -g @anthropic/mcp-server-atlassian
2. Configure ~/.claude/mcp_servers.json (see mcp_servers.json.example)
3. Restart Claude Code
4. Run /sync-jira again

See README.md "Jira Integration" section for details.
```

---

## Step 4: Create Jira Epic

### Epic Details

Create the epic with:
- **Project**: From `jira.json` projectKey
- **Issue Type**: From `jira.json` epicIssueType
- **Summary**: `[PRD] {prd.project}`
- **Description**: Build from PRD fields:

```
h2. Project Overview

{prd.description}

h2. Branch

{prd.branchName}

h2. User Stories

{count} user stories to be implemented.

h2. Generated by Ralph

This epic was automatically created from prd.json by the /sync-jira skill.
```

- **Labels**: From `jira.json` defaultLabels plus "ralph-epic"
- **Components**: From `jira.json` components (if configured)

### Store Epic Key

After creation, store the epic key (e.g., "PROJ-123") for:
1. Linking story tickets
2. Updating prd.json

---

## Step 5: Create Story Tickets

For each user story in `prd.userStories` (in priority order):

### Story Details

- **Project**: From `jira.json` projectKey
- **Issue Type**: From `jira.json` storyIssueType
- **Summary**: `[{story.id}]: {story.title}`
- **Description**: Format as Jira markup:

```
h2. User Story

{story.description}

h2. Acceptance Criteria

{For each criterion in story.acceptanceCriteria:}
* [ ] {criterion}

h2. Priority

{story.priority}

h2. Implementation Status

Passes: {story.passes}
Notes: {story.notes or "None"}

----
_Created by Ralph /sync-jira skill_
```

- **Labels**: From `jira.json` defaultLabels plus "ralph-story"
- **Epic Link**: Link to the epic created in Step 4
- **Components**: From `jira.json` components (if configured)

### Link to Epic

Use the appropriate method based on Jira version:
1. Try `epicLinkField` from config (e.g., "Epic Link" custom field)
2. Fall back to "Parent" field for newer Jira versions

### Track Created Tickets

Collect all created ticket keys for the summary and prd.json update.

---

## Step 6: Update prd.json

After all tickets are created, update prd.json:

### Add Epic Key

```json
{
  "project": "...",
  "branchName": "...",
  "description": "...",
  "jiraEpicKey": "PROJ-100",  // ADD THIS
  "userStories": [...]
}
```

### Add Story Keys

```json
{
  "userStories": [
    {
      "id": "US-001",
      "title": "...",
      "jiraKey": "PROJ-101",  // ADD THIS to each story
      ...
    }
  ]
}
```

---

## Step 7: Output Summary

Display a summary of what was created:

```
## Jira Sync Complete

### Epic Created
- **{epicKey}**: [PRD] {project name}
  {atlassianSiteUrl}/browse/{epicKey}

### Story Tickets Created
| Story ID | Jira Key | Title |
|----------|----------|-------|
| US-001   | PROJ-101 | Story title 1 |
| US-002   | PROJ-102 | Story title 2 |
| ...      | ...      | ... |

### prd.json Updated
- Added `jiraEpicKey: "{epicKey}"`
- Added `jiraKey` to {count} user stories

### Next Steps
1. Run Ralph to start implementing: `./ralph.sh`
2. Tickets will auto-update as stories complete
3. View epic in Jira: {atlassianSiteUrl}/browse/{epicKey}
```

---

## Error Handling

### Partial Failure Recovery

If epic creates but some stories fail:
1. Report which stories failed
2. Still update prd.json with successful tickets
3. Provide instructions to manually create failed tickets or re-run

### Duplicate Detection

Before creating, check if `jiraEpicKey` already exists in prd.json:

```
Warning: prd.json already has jiraEpicKey: PROJ-100

Options:
1. Skip - Keep existing Jira tickets (recommended if tickets exist)
2. Continue - Create new epic (will result in duplicate tickets)

Choose an option:
```

### Rate Limiting

If Jira API returns rate limit errors:
1. Wait and retry with exponential backoff
2. After 3 retries, stop and report partial progress
3. User can re-run to continue from where it stopped

---

## MCP Tool Reference

The skill uses these Atlassian MCP server tools:

### Creating Issues
```
Tool: jira-create-issue (or atlassian_jira_create_issue)
Parameters:
  - project: Project key
  - issueType: Issue type name
  - summary: Issue title
  - description: Issue body (Jira wiki markup)
  - labels: Array of label strings
  - parent/epicLink: Parent issue key (for linking to epic)
```

### Getting Issue Types
```
Tool: jira-get-issue-types (or atlassian_jira_get_issue_types)
Parameters:
  - project: Project key
Returns: List of available issue types for the project
```

### Getting Transitions (for future use)
```
Tool: jira-get-transitions (or atlassian_jira_get_transitions)
Parameters:
  - issueKey: Issue key (e.g., "PROJ-123")
Returns: List of available status transitions
```

Note: Exact tool names may vary based on MCP server version. The skill should try common variations.

---

## Checklist

Before completing:

- [ ] PRD file found and validated
- [ ] Jira configuration loaded and validated
- [ ] MCP connection verified
- [ ] Epic created successfully
- [ ] All story tickets created and linked to epic
- [ ] prd.json updated with jiraEpicKey and story jiraKeys
- [ ] Summary displayed to user
