---
name: sync-jira
description: "Push a validated PRD to Jira, creating an epic and linked story tickets. Use when you have a prd.json ready and want to track it in Jira. Triggers on: sync to jira, push to jira, create jira tickets, sync-jira."
---

# Sync PRD to Jira

Pushes a validated prd.json to Atlassian Jira, creating an epic for the project and individual tickets for each user story.

---

## Prerequisites

Before running this skill, ensure:

1. **Atlassian MCP server is configured** in `~/.claude/mcp_servers.json`
2. **Per-project Jira config exists** at `.ralph/jira.json` (copy from `.ralph/jira.json.example`)
3. **prd.json exists** with valid user stories

---

## The Job

1. Validate prerequisites (Jira config, PRD file)
2. Create a Jira epic for the PRD
3. Create story tickets linked to the epic
4. Update prd.json with Jira references

---

## Step 1: Locate and Validate PRD

### Find PRD File

Check for prd.json in the following locations (in order):
1. Current working directory: `./prd.json`
2. User-specified path (if provided as argument)

If no prd.json found, check for PRD markdown files:
1. `tasks/prd-*.md` files
2. If multiple exist, prompt user to specify which one

**If no PRD found:** Stop and inform user to create a PRD first using `/prd` skill, then convert with `/ralph` skill.

### Validate PRD Structure

The prd.json must contain:
```json
{
  "project": "string (required)",
  "branchName": "string (required)",
  "description": "string (required)",
  "userStories": [
    {
      "id": "string (required)",
      "title": "string (required)",
      "description": "string (required)",
      "acceptanceCriteria": ["array of strings (required)"],
      "priority": "number (required)",
      "passes": "boolean (required)",
      "notes": "string (optional)"
    }
  ]
}
```

**Validation errors:** Stop and report missing/invalid fields.

---

## Step 2: Validate Jira Configuration

### Load Configuration

Read `.ralph/jira.json` from the project root.

**If file doesn't exist:**
```
Error: Jira configuration not found at .ralph/jira.json

To set up Jira integration:
1. Copy the example: cp .ralph/jira.json.example .ralph/jira.json
2. Edit .ralph/jira.json with your project settings
3. Run /sync-jira again

See README.md "Jira Integration" section for details.
```

### Required Fields

Validate these fields exist and are non-empty:
- `projectKey` - Jira project key (e.g., "PROJ")
- `atlassianSiteUrl` - Atlassian instance URL
- `epicIssueType` - Issue type for epics (usually "Epic")
- `storyIssueType` - Issue type for stories

### Optional Fields (with defaults)

- `subtaskIssueType` - Default: "Sub-task"
- `defaultLabels` - Default: []
- `statusMapping` - Default: { "start": "In Progress", "done": "Done", "fail": "In Progress" }
- `epicLinkField` - Default: "Epic Link"
- `components` - Default: []
- `customFields` - Default: {}

---

## Step 3: Verify MCP Connection

Before creating any tickets, verify the Atlassian MCP server is available.

### Check MCP Tools

Attempt to list available Jira tools. The Atlassian MCP server should provide:
- `jira-create-issue` or similar for creating issues
- `jira-get-issue-types` for listing issue types

**If MCP tools not available:**
```
Error: Atlassian MCP server not configured or not responding.

To set up the MCP server:
1. Install: npm install -g @anthropic/mcp-server-atlassian
2. Configure ~/.claude/mcp_servers.json (see mcp_servers.json.example)
3. Restart Claude Code
4. Run /sync-jira again

See README.md "Jira Integration" section for details.
```

---

## Step 4: Create Jira Epic

### Epic Details

Create the epic with:
- **Project**: From `jira.json` projectKey
- **Issue Type**: From `jira.json` epicIssueType
- **Summary**: `[PRD] {prd.project}`
- **Description**: Build from PRD fields:

```
h2. Project Overview

{prd.description}

h2. Branch

{prd.branchName}

h2. User Stories

{count} user stories to be implemented.

h2. Generated by Ralph

This epic was automatically created from prd.json by the /sync-jira skill.
```

- **Labels**: From `jira.json` defaultLabels plus "ralph-epic"
- **Components**: From `jira.json` components (if configured)

### Store Epic Key

After creation, store the epic key (e.g., "PROJ-123") for:
1. Linking story tickets
2. Updating prd.json

---

## Step 5: Create Story Tickets

Create a Jira ticket for **each user story** in the PRD. Each story becomes one Jira issue linked to the parent epic.

### Sort Stories by Priority

Before creating tickets, sort `prd.userStories` by the `priority` field (ascending order - lower number = higher priority). This ensures:
- Tickets are created in the same order they appear in the PRD
- Jira issue numbers roughly correspond to implementation order
- The backlog view reflects the intended work sequence

```javascript
// Sort stories by priority (1 = highest priority, created first)
const sortedStories = [...prd.userStories].sort((a, b) => a.priority - b.priority);
```

### Iterate and Create Each Ticket

For each story in the sorted list, create a Jira ticket:

```
FOR each story IN sortedStories:
  1. Build ticket summary: "[{story.id}]: {story.title}"
  2. Build ticket description (see format below)
  3. Create issue via MCP tool
  4. Store returned jiraKey with story.id for later prd.json update
  5. Log success or handle error
```

### Ticket Summary Format

```
[{story.id}]: {story.title}
```

**Examples:**
- `[US-001]: Configure Atlassian MCP server connection`
- `[US-002]: Create Jira configuration file structure`
- `[US-005]: Map user stories to Jira tickets in sync-jira`

### Ticket Description Format (Jira Wiki Markup)

Build the description using Jira wiki markup syntax. The `* [ ]` format creates interactive checkboxes in Jira:

```
h2. User Story

{story.description}

h2. Acceptance Criteria

{For each criterion in story.acceptanceCriteria:}
* [ ] {criterion}

h2. Metadata

||Field||Value||
|Priority|{story.priority}|
|Story ID|{story.id}|
|Implementation Status|{story.passes ? "Complete" : "Pending"}|

{If story.notes is not empty:}
h2. Notes

{story.notes}

----
_Created by Ralph /sync-jira skill_
```

**Acceptance Criteria as Checklist:**

The `* [ ]` markup creates checkboxes in Jira. Example for a story with 3 criteria:

```
h2. Acceptance Criteria

* [ ] Document MCP server setup in README.md with step-by-step instructions
* [ ] Add Atlassian MCP server URL to Claude Code settings template
* [ ] Document required Jira permissions (create issues, transition, comment)
```

This renders as an interactive checklist in Jira that team members can check off during review.

### Ticket Fields

- **Project**: From `jira.json` projectKey
- **Issue Type**: From `jira.json` storyIssueType
- **Summary**: `[{story.id}]: {story.title}`
- **Description**: Formatted as shown above
- **Labels**: From `jira.json` defaultLabels plus "ralph-story"
- **Epic Link**: Link to the epic created in Step 4
- **Components**: From `jira.json` components (if configured)

### Link Each Ticket to Epic

Each story ticket must be linked to the parent epic. Use the appropriate method based on Jira version:

1. **Try `epicLinkField`** from config (e.g., "Epic Link" custom field)
   - Common in Jira Server and older Jira Cloud
   - Field name varies: "Epic Link", "customfield_10014", etc.

2. **Fall back to "Parent" field** for newer Jira versions
   - Jira Cloud next-gen projects use parent-child hierarchy
   - Set `parent: { key: epicKey }` in the create request

**MCP Create Issue Example:**
```json
{
  "project": "PROJ",
  "issueType": "Story",
  "summary": "[US-001]: Configure Atlassian MCP server connection",
  "description": "h2. User Story\n\nAs a developer...\n\nh2. Acceptance Criteria\n\n* [ ] Document MCP server setup...",
  "labels": ["ralph-story", "automated"],
  "parent": "PROJ-100"
}
```

### Track Created Tickets

Maintain a mapping of story IDs to created Jira keys:

```javascript
const ticketMap = {
  "US-001": "PROJ-101",
  "US-002": "PROJ-102",
  "US-003": "PROJ-103",
  // ... etc
};
```

This map is used in Step 6 to update prd.json.

---

## Step 6: Update prd.json

After all tickets are created, update prd.json with Jira references. This is **critical** for Ralph's Jira status updates to work during story execution.

### Update Process

```
1. Read current prd.json content
2. Add jiraEpicKey at the project level
3. For each story in userStories:
   a. Find the matching entry in ticketMap (from Step 5)
   b. Add jiraKey field with the Jira issue key
4. Write updated prd.json back to disk
5. Verify the file was written successfully
```

### Add Epic Key at Project Level

Set `jiraEpicKey` to the epic key returned from Step 4:

```json
{
  "project": "Ralph Jira Integration",
  "branchName": "ralph/jira-integration",
  "description": "...",
  "jiraEpicKey": "PROJ-100",
  "userStories": [...]
}
```

### Add Story Keys to Each User Story

Using the `ticketMap` from Step 5, add `jiraKey` to each story:

```javascript
// Pseudocode for updating stories
for (const story of prd.userStories) {
  const jiraKey = ticketMap[story.id];  // e.g., "PROJ-101"
  if (jiraKey) {
    story.jiraKey = jiraKey;
  } else {
    story.jiraKey = null;  // Story failed to create in Jira
  }
}
```

### Example: Before and After

**Before sync-jira:**
```json
{
  "project": "TaskApp",
  "branchName": "ralph/task-status",
  "description": "Task Status Feature",
  "jiraEpicKey": null,
  "userStories": [
    {
      "id": "US-001",
      "title": "Add status field",
      "priority": 1,
      "passes": false,
      "notes": "",
      "jiraKey": null
    }
  ]
}
```

**After sync-jira:**
```json
{
  "project": "TaskApp",
  "branchName": "ralph/task-status",
  "description": "Task Status Feature",
  "jiraEpicKey": "PROJ-100",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add status field",
      "priority": 1,
      "passes": false,
      "notes": "",
      "jiraKey": "PROJ-101"
    }
  ]
}
```

### Handling Missing jiraKey Fields

If the original prd.json was created before Jira integration existed (no `jiraKey` fields), add them during the update:

```javascript
// Add jiraKey field if it doesn't exist
if (!story.hasOwnProperty('jiraKey')) {
  story.jiraKey = ticketMap[story.id] || null;
}
```

---

## Step 7: Output Summary

Display a comprehensive summary of what was created. This summary helps users verify the sync was successful and provides quick access to the Jira links.

### Summary Format

```
## Jira Sync Complete ✓

### Epic Created
- **{epicKey}**: [PRD] {project name}
- Link: {atlassianSiteUrl}/browse/{epicKey}

### Story Tickets Created ({count} tickets)

| Story ID | Jira Key | Title | Link |
|----------|----------|-------|------|
| US-001   | PROJ-101 | Configure Atlassian MCP... | [PROJ-101]({url}) |
| US-002   | PROJ-102 | Create Jira config file... | [PROJ-102]({url}) |
| US-003   | PROJ-103 | Add graceful degradation... | [PROJ-103]({url}) |
| ...      | ...      | ... | ... |

### prd.json Updated
- ✓ Added `jiraEpicKey: "{epicKey}"` at project level
- ✓ Added `jiraKey` to {count} user stories:
  - US-001 → PROJ-101
  - US-002 → PROJ-102
  - US-003 → PROJ-103
  - ...

### Next Steps
1. Run Ralph to start implementing: `./ralph.sh`
2. Tickets will auto-transition as stories complete (In Progress → Done)
3. View epic in Jira: {atlassianSiteUrl}/browse/{epicKey}
4. View project board: {atlassianSiteUrl}/jira/software/projects/{projectKey}/board
```

### Key Information to Include

1. **Epic key and direct link** - Users need quick access to the parent epic
2. **All story keys with links** - Complete traceability from PRD to Jira
3. **prd.json update confirmation** - Verify the local file was updated
4. **Mapping summary** - Show which story ID maps to which Jira key
5. **Next steps** - Guide users on what to do after sync

---

## Error Handling

### Partial Failure Recovery

If epic creates but some stories fail:
1. Report which stories failed
2. Still update prd.json with successful tickets
3. Provide instructions to manually create failed tickets or re-run

### Duplicate Detection

Before creating, check if `jiraEpicKey` already exists in prd.json:

```
Warning: prd.json already has jiraEpicKey: PROJ-100

Options:
1. Skip - Keep existing Jira tickets (recommended if tickets exist)
2. Continue - Create new epic (will result in duplicate tickets)

Choose an option:
```

### Rate Limiting

If Jira API returns rate limit errors:
1. Wait and retry with exponential backoff
2. After 3 retries, stop and report partial progress
3. User can re-run to continue from where it stopped

---

## MCP Tool Reference

The skill uses these Atlassian MCP server tools:

### Creating Issues
```
Tool: jira-create-issue (or atlassian_jira_create_issue)
Parameters:
  - project: Project key
  - issueType: Issue type name
  - summary: Issue title
  - description: Issue body (Jira wiki markup)
  - labels: Array of label strings
  - parent/epicLink: Parent issue key (for linking to epic)
```

### Getting Issue Types
```
Tool: jira-get-issue-types (or atlassian_jira_get_issue_types)
Parameters:
  - project: Project key
Returns: List of available issue types for the project
```

### Getting Transitions (for future use)
```
Tool: jira-get-transitions (or atlassian_jira_get_transitions)
Parameters:
  - issueKey: Issue key (e.g., "PROJ-123")
Returns: List of available status transitions
```

Note: Exact tool names may vary based on MCP server version. The skill should try common variations.

---

## Checklist

Before completing:

- [ ] PRD file found and validated
- [ ] Jira configuration loaded and validated
- [ ] MCP connection verified
- [ ] Epic created successfully
- [ ] All story tickets created and linked to epic
- [ ] prd.json updated with jiraEpicKey and story jiraKeys
- [ ] Summary displayed to user
